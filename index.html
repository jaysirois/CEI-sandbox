<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compliance Roadmap</title>
  <style>
    body{font-family:Arial, sans-serif;margin:20px;background:#F5F5F5}
    .container{max-width:1200px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .header{background:#007e83;color:#fff;padding:16px;border-radius:8px 8px 0 0;text-align:center}
    .section{padding:20px;border-bottom:1px solid #e0e0e0}
    .section:last-child{border-bottom:none}
    .section h2{margin:0 0 12px;font-size:1.5em;color:#333}
    .flex-container{display:flex;gap:20px;align-items:center;flex-wrap:wrap}
    .flex-item{flex:1;min-width:260px}
    label{display:block;margin:0 0 6px}
    select,button,input[type="text"]{padding:10px;font-size:1em;border:1px solid #ccc;border-radius:4px;width:100%;margin-bottom:10px}
    button{background:#007e83;color:#fff;border:none;cursor:pointer}
    button:hover{background:#5fb9bc}
    .attributes-list,.destinations-list,.certifications-list{max-height:260px;overflow-y:auto;border:1px solid #ccc;border-radius:4px;padding:10px}
    .attribute-item,.market-item,.certification-item{display:flex;align-items:center;margin:6px 0}
    .attribute-item input,.market-item input,.certification-item input{margin-right:10px}
    .compliance-roadmap{margin-top:20px;padding:15px;background:#F5F5F5;border:1px solid #e0e0e0;border-radius:4px}
    .compliance-roadmap h3{margin:0 0 8px;color:#006666}
    .compliance-roadmap ul{list-style:none;padding:0;margin:0 0 18px}
    .button-group{display:flex;gap:16px;flex-wrap:wrap;align-items:stretch;margin-top:28px}
    .button-group button{flex:1;min-width:220px;border-radius:8px}
    .export-btn{background:#C86DD7}
    .export-btn:hover{background:#B55AC3}
    .export-csv-btn{background:#FF6200}
    .export-csv-btn:hover{background:#E55B00}
    .hint{color:#666;font-size:.9em;margin:6px 0 12px}
    .req-star::after{content:" *required";color:#b00020;font-weight:600;margin-left:4px}
    .req-badge{color:#b00020;font-weight:600}
    .muted{color:#666;font-size:.9em}
    .pill{display:inline-block;background:#eef7f7;border:1px dashed #8cc;color:#066;padding:6px 10px;border-radius:12px;margin:6px 8px 0 0}
/* Apply the green halo to both attributes and certifications */
.attribute-item label.auto-suggest,
.certification-item label.auto-suggest {
  display: inline-block;            /* prevents outline clipping */
  outline: 2px solid #a6e3a1;
  background: #f6fff6;
  border-radius: 4px;
  padding: 2px 6px;
  transition: outline-color .15s ease, background-color .15s ease;
}

/* (optional) a subtle focus effect for keyboard users */
.attribute-item input:focus + label,
.certification-item input:focus + label {
  outline: 2px solid #9bd890;
  background: #f3fff3;
}
    .subbox{border:1px solid #d7eaea;background:#f6fbfb;border-radius:6px;padding:10px;margin-top:10px}
    .group-title{font-weight:600;margin:6px 0 4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Compliance Roadmap</h1></div>

    <!-- Define -->
    <div class="section">
      <h2>Define Specification</h2>

      <label for="product">Products or Systems</label>
      <select id="product">
        <option value="none">Select Product or System</option>
        <option value="machinery">Machinery (EN IEC 60204-1)</option>
        <option value="low-voltage-switchgear">Low-voltage switchgear and controlgear assemblies (EN IEC 61439-1/-2)</option>
        <option value="alarm-systems">Alarm systems for intrusion and hold-up installations (EN 50131-1)</option>
        <option value="lightning-protection">Protection against lightning: Electrical/electronic systems within structures (EN IEC 62305-4)</option>
        <option value="electrical-equipment-measurement">Electrical equipment for measurement, control and laboratory use (EN 61010-1)</option>
        <option value="explosive-atmospheres-installation">Explosive atmospheres ‚Äì Electrical installation (EN IEC 60079-14)</option>
        <option value="traction-batteries">Traction batteries (EN 62485-3)</option>
        <option value="laser-products">Laser products: equipment (EN 60825-1)</option>
        <option value="luminaires">Luminaires (EN IEC 60598-1)</option>
        <option value="explosive-atmospheres-equipment">Equipment for Explosive atmospheres (EN IEC 60079-0)</option>
        <option value="medical-electrical-equipment">Medical electrical equipment (EN 60601-1)</option>
        <option value="heat-pumps-airconditioners">Electrical heat pumps, air conditioners and dehumidifiers (EN IEC 60335-2-40)</option>
        <option value="stationary-batteries">Stationary batteries (EN IEC 62485-2)</option>
        <option value="power-installations">Power installations exceeding 1 kV AC / 1.5 kV DC (EN IEC 61936-1)</option>
        <option value="audio-video-equipment">Audio/video, information & communication technology equipment (EN IEC 62368-1)</option>
        <option value="photovoltaic-systems">Photovoltaic (PV) grid connected systems (EN 62446-1)</option>
        <option value="low-voltage-cables">Low-voltage energy cables ‚â§ 450/750 V (EN 50525-1)</option>
        <option value="video-surveillance">Video surveillance systems for use in security applications (EN 62676-4)</option>
        <option value="commercial-refrigerating">Commercial refrigerating appliances and ice-makers (EN IEC 60335-2-89)</option>
        <option value="air-cleaning-appliances">Air-cleaning appliances (EN 60335-2-65)</option>
      </select>

      <!-- Machinery-only: variants & details -->
      <div id="machinery-variant-block" style="display:none;margin-top:10px;border:1px dashed #cfe9ea;background:#f8fcfc;padding:12px;border-radius:8px">
        <label for="mach-variant"><strong>Machinery Variant</strong></label>
        <select id="mach-variant">
          <option value="none">Select a Machinery variant</option>
        </select>
        <div class="muted">Tip: Selecting variant/options adds the corresponding type-C standards to the results. You can still adjust attributes manually below.</div>

        <div id="variant-details" class="subbox" style="display:none"></div>
      </div>
    </div>

    <!-- Attributes -->
    <div class="section">
      <h2>Select Attributes</h2>
      <input type="text" id="attributes-search" placeholder="Search attributes..." onkeyup="filterAttributes()"/>
      <div class="attributes-list" id="attributes-list">
        <!-- Common / existing -->
        <div class="attribute-item" data-products="machinery,low-voltage-switchgear,heat-pumps-airconditioners,commercial-refrigerating,air-cleaning-appliances,medical-electrical-equipment">
          <input type="checkbox" id="external-power-supply" value="external-power-supply">
          <label for="external-power-supply">External Power Supply ‚Äî (EU) 2019/1782 ecodesign; safety in relevant product standard.</label>
        </div>
        <div class="attribute-item" data-products="explosive-atmospheres-installation,explosive-atmospheres-equipment,power-installations">
          <input type="checkbox" id="hazardous-environment-design" value="hazardous-environment-design">
          <label for="hazardous-environment-design">Use in explosive atmospheres (non-machinery) ‚Äî Explosive Atmosphere product/installation rules (2014/34/EU & 60079-14).</label>
        </div>
        <div class="attribute-item" data-products="audio-video-equipment,video-surveillance">
          <input type="checkbox" id="wireless-connectivity" value="wireless-connectivity">
          <label for="wireless-connectivity">Wireless HMI / Connectivity ‚Äî Radio Equipment Directive (EU), GB Radio Regs, FCC.</label>
        </div>
        <div class="attribute-item" data-products="low-voltage-cables">
          <input type="checkbox" id="fire-resistant" value="fire-resistant">
          <label for="fire-resistant">Cables: Fire performance (CPR/EN 50575 + EN 60332-1-2).</label>
        </div>
        <div class="attribute-item" data-products="low-voltage-cables">
          <input type="checkbox" id="high-temperature-operation" value="high-temperature-operation">
          <label for="high-temperature-operation">Cables: High temperature (pick correct EN 50525-2-xx part).</label>
        </div>
        <div class="attribute-item" data-products="audio-video-equipment,video-surveillance,medical-electrical-equipment">
          <input type="checkbox" id="data-processing-capability" value="data-processing-capability">
          <label for="data-processing-capability">Software / Cybersecurity ‚Äî IEC 62443 / ETSI EN 303 645 (consumer), GDPR where personal data.</label>
        </div>
        <div class="attribute-item" data-products="machinery,low-voltage-switchgear,heat-pumps-airconditioners,commercial-refrigerating,air-cleaning-appliances,medical-electrical-equipment,laser-products,luminaires,explosive-atmospheres-equipment">
          <input type="checkbox" id="safety-critical-component" value="safety-critical-component">
          <label for="safety-critical-component">Safety-critical component ‚Äî expect tighter safety evidence per product standard.</label>
        </div>
        <div class="attribute-item" data-products="machinery,video-surveillance,audio-video-equipment,medical-electrical-equipment">
        <input type="checkbox" id="software-cyber" value="software-cyber">
        <label for="software-cyber">Software / Cybersecurity (machinery control systems) ‚Äî e.g., IEC 62443 / security hardening.</label>
      </div>
        <!-- Machinery-only focused -->
        <div class="attribute-item" data-products="machinery">
          <input type="checkbox" id="functional-safety" value="functional-safety">
          <label for="functional-safety">Functional safety (PL/SIL) ‚Äî EN ISO 13849-1/-2 or IEC 62061.</label>
        </div>
        <div class="attribute-item" data-products="machinery">
          <input type="checkbox" id="wireless-hmi" value="wireless-hmi">
          <label for="wireless-hmi">Wireless HMI on machine ‚Äî Radio Equipment Directive/FCC as applicable.</label>
        </div>
<div class="attribute-item" data-products="machinery">
  <input type="checkbox" id="hydraulic-power" value="hydraulic-power">
  <label for="hydraulic-power">Hydraulic fluid power ‚Äî EN ISO 4413 (safety for hydraulic systems).</label>
</div>
<div class="attribute-item" data-products="machinery">
  <input type="checkbox" id="pneumatic-power" value="pneumatic-power">
  <label for="pneumatic-power">Pneumatic fluid power ‚Äî EN ISO 4414 (safety for pneumatic systems).</label>
</div>
<!-- Conditional Directives (EU only) -->
<div class="attribute-item" data-products="machinery">
  <input type="checkbox" id="emc-electrical-disturbance" value="emc-electrical-disturbance">
  <label for="emc-electrical-disturbance">
    Electrical equipment / Electromagnetic Compatibility ‚Äî 2014/30/EU (applies if the machine contains electrical or electronic equipment that can generate or be disturbed by EM noise).
  </label>
</div>
<div class="attribute-item" data-products="machinery">
  <input type="checkbox" id="pressure-equipment" value="pressure-equipment">
  <label for="pressure-equipment">
    Pressure Equipment ‚Äî 2014/68/EU (applies if the machine contains pressurized parts, piping, or vessels above the Pressure Equipment Directive thresholds).
  </label>
</div>
<div class="attribute-item" data-products="machinery">
  <input type="checkbox" id="hazardous-location" value="hazardous-location">
  <label for="hazardous-location">
    Use in potentially explosive atmospheres (ATEX) ‚Äî 2014/34/EU (applies if the machine is intended for operation in a zoned area).
  </label>
</div>
<div class="attribute-item" data-products="machinery">
  <input type="checkbox" id="outdoor-use" value="outdoor-use">
  <label for="outdoor-use">
    Outdoor noise emission ‚Äî 2000/14/EC (applies if the machine is intended for outdoor use).
  </label>
</div>
      </div>
    </div>
    <!-- Certifications -->
    <div class="section">
      <h2>Certification Bodies/Goals</h2>
      <div class="certifications-list">
        <div class="certification-item"><input type="checkbox" id="ce-marking" value="ce-marking"><label for="ce-marking">CE Marking (EU)</label></div>
        <div class="certification-item"><input type="checkbox" id="ukca-ce-gb" value="ukca-ce-gb"><label for="ukca-ce-gb">UKCA / CE (Great Britain)</label></div>
        <div class="certification-item"><input type="checkbox" id="ul-listing" value="ul-listing"><label for="ul-listing">NRTL Listing (UL/CSA/ETL) ‚Äì US</label></div>
        <div class="certification-item"><input type="checkbox" id="fda-approval" value="fda-approval"><label for="fda-approval">FDA (US medical devices)</label></div>
        <div class="certification-item"><input type="checkbox" id="ce-notified-body" value="ce-notified-body"><label for="ce-notified-body">Notified Body / UK Approved Body</label></div>
      </div>

      <div id="gb-marking-plan" style="display:none;margin-top:8px">
        <label for="gb-plan">GB marking plan</label>
        <select id="gb-plan">
          <option value="ce">CE only (permitted for most sectors)</option>
          <option value="ukca">UKCA only</option>
          <option value="dual">Dual marking (CE + UKCA)</option>
        </select>
      </div>
    </div>

    <!-- Origin -->
    <div class="section">
      <h2>Place of manufacture (origin)</h2>
      <div class="flex-container">
        <div class="flex-item">
          <select id="country-of-origin">
            <option value="none">Select origin country</option>
            <option value="france">France</option>
            <option value="germany">Germany</option>
            <option value="italy">Italy</option>
            <option value="uk">United Kingdom</option>
            <option value="usa">United States</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Destinations -->
    <div class="section">
      <h2>Destination market(s)</h2>
      <input type="text" id="destinations-search" placeholder="Search destinations..." onkeyup="filterDestinations()"/>
      <div class="destinations-list">
        <div class="market-item"><input type="checkbox" value="france"><label>France (EU)</label></div>
        <div class="market-item"><input type="checkbox" value="germany"><label>Germany (EU)</label></div>
        <div class="market-item"><input type="checkbox" value="italy"><label>Italy (EU)</label></div>
        <div class="market-item"><input type="checkbox" value="uk"><label>United Kingdom (UK)</label></div>
        <div class="market-item"><input type="checkbox" value="usa"><label>United States of America (USA)</label></div>
      </div>
    </div>

    <!-- Advanced -->
    <div class="section" id="advanced-section" style="display:none">
      <h2>Advanced &amp; economic operators</h2>
      <p class="hint">Fields below are optional unless your selections make them required. Required fields are marked with <span class="req-badge">*required</span>.</p>

      <div class="flex-container">
        <div class="flex-item">
          <label for="legal-manufacturer-country">Legal manufacturer country (optional)</label>
          <select id="legal-manufacturer-country">
            <option value="none">Same as place of manufacture</option>
            <option value="france">France</option>
            <option value="germany">Germany</option>
            <option value="italy">Italy</option>
            <option value="uk">United Kingdom</option>
            <option value="usa">United States</option>
          </select>
        </div>
      </div>

      <div id="eu-ops" style="display:none;margin-top:12px">
        <h3 style="margin:0 0 8px">EU economic operator locations</h3>
        <div class="flex-container">
          <div class="flex-item">
            <label id="lbl-eu-importer" for="eu-importer-country">EU importer country</label>
            <select id="eu-importer-country">
              <option value="none">Select country</option>
              <option value="france">France</option>
              <option value="germany">Germany</option>
              <option value="italy">Italy</option>
            </select>
          </div>
          <div class="flex-item">
            <label id="lbl-eu-ar" for="eu-ar-country">EU Authorized Representative country (if applicable)</label>
            <select id="eu-ar-country">
              <option value="none">Not applicable / not yet decided</option>
              <option value="france">France</option>
              <option value="germany">Germany</option>
              <option value="italy">Italy</option>
            </select>
          </div>
        </div>
      </div>

      <div id="uk-ops" style="display:none;margin-top:12px">
        <h3 style="margin:0 0 8px">UK economic operator locations</h3>
        <div class="flex-container">
          <div class="flex-item">
            <label id="lbl-uk-importer" for="uk-importer-country">UK importer country</label>
            <select id="uk-importer-country">
              <option value="none">Select country</option>
              <option value="uk">United Kingdom</option>
            </select>
          </div>
          <div class="flex-item">
            <label id="lbl-ukrp" for="ukrp-country">UK Responsible Person (UKRP) country (if applicable)</label>
            <select id="ukrp-country">
              <option value="none">Not applicable / not yet decided</option>
              <option value="uk">United Kingdom</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="section"><button onclick="generateRoadmap()">Generate Compliance Roadmap</button></div>

    <!-- Output -->
    <div class="section" id="roadmap-section" style="display:none">
      <h2>Compliance Roadmap</h2>
      <div class="compliance-roadmap">
        <h3>Applicable Standards and Requirements</h3>
        <ul id="roadmap-list"></ul>
        <div class="button-group">
          <button class="export-btn" onclick="exportToCitation()">Create My Review</button>
          <button class="export-csv-btn" onclick="exportToCSV()">Export My Requirements</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ------------ Catalog (one source of truth) ------------- */
const CATALOG_URL = 'catalog.json?v=' + Date.now();   // cache-bust for GH Pages
let CATALOG = null;

async function loadCatalog() {
  const res = await fetch(CATALOG_URL, { cache: 'no-store' });
  if (!res.ok) throw new Error('Failed to load catalog.json: ' + res.status);
  CATALOG = await res.json();
  // expose for debugging if you like
  window.catalog = CATALOG;
}

// Normalize: works with EITHER variants: [] OR variants: {id:{...}}
function getMachineryVariants() {
  const v = CATALOG?.products?.machinery?.variants;
  if (!v) return [];
  return Array.isArray(v) ? v : Object.keys(v).map(id => ({ id, ...(v[id] || {}) }));
}

function getCatalogVariant(id){
  return getMachineryVariants().find(v => v.id === id) || null;
}
  
/* ------------ Helpers / search ------------- */
function filterAttributes(){
  const q = document.getElementById('attributes-search').value.toLowerCase();
  document.querySelectorAll('.attribute-item').forEach(item=>{
    const txt = item.querySelector('label').textContent.toLowerCase();
    item.style.display = txt.includes(q) ? 'flex':'none';
  });
}
function filterDestinations(){
  const q = document.getElementById('destinations-search').value.toLowerCase();
  document.querySelectorAll('.market-item').forEach(item=>{
    const txt = item.querySelector('label').textContent.toLowerCase();
    item.style.display = txt.includes(q) ? 'flex':'none';
  });
}
function getSelectedDestinations(){
  return Array.from(document.querySelectorAll('.market-item input[type=checkbox]:checked')).map(x=>x.value);
}
function getSelectedCertifications(){
  return Array.from(document.querySelectorAll('.certification-item input[type=checkbox]:checked')).map(x=>x.value);
}
function getSelectedAttributes(){
  return Array.from(document.querySelectorAll('.attribute-item input[type=checkbox]:checked')).map(x=>x.value);
}
  function clearAutoSuggest() {
  document.querySelectorAll('.attribute-item label')
    .forEach(l => l.classList.remove('auto-suggest'));
}

function resetMachineryContext() {
  // reset the variant UI + remove any leftover attribute highlights
  const sel = document.getElementById('mach-variant');
  if (sel) sel.value = 'none';
  const box = document.getElementById('variant-details');
  if (box) { box.style.display = 'none'; box.innerHTML = ''; }
  clearAutoSuggest();
}

/* ------------ Show/hide Advanced & GB block ------------- */
const EU_SET = new Set(['france','germany','italy']);
const MARKET_GROUP = { germany:'eu', france:'eu', italy:'eu', uk:'uk', usa:'us' };

function anyEUSelected(){ return getSelectedDestinations().some(x=>EU_SET.has(x)); }
function anyUKSelected(){ return getSelectedDestinations().includes('uk'); }
function toggleAdvancedSection(){
  const show = anyEUSelected() || anyUKSelected();
  document.getElementById('advanced-section').style.display = show ? 'block':'none';
  document.getElementById('eu-ops').style.display = anyEUSelected() ? 'block':'none';
  document.getElementById('uk-ops').style.display = anyUKSelected() ? 'block':'none';
  document.getElementById('gb-marking-plan').style.display = anyUKSelected() ? 'block':'none';
  markRequiredFields();
}

/* ------------ Required state for operators ------------- */
function computeOperatorRequirements(){
  const dest = getSelectedDestinations();
  const legalManu = document.getElementById('legal-manufacturer-country').value || 'none';
  const origin = document.getElementById('country-of-origin').value;
  const manu = (legalManu!=='none') ? legalManu : origin;
  const goingEU = dest.some(d=>EU_SET.has(d));
  const goingUK = dest.includes('uk');
  const isMedical = (document.getElementById('product').value==='medical-electrical-equipment') ||
                    getSelectedAttributes().includes('medical-application');
  return {
    needsEUImporter: goingEU && !EU_SET.has(manu),
    needsEUAR:       goingEU && isMedical && !EU_SET.has(manu),
    needsGBImporter: goingUK && manu!=='uk',
    needsUKRP:       goingUK && isMedical && manu!=='uk'
  };
}
function labelReq(selectId,isReq){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const lbl = sel.closest('.flex-item').querySelector('label');
  lbl.classList.toggle('req-star',!!isReq);
}
function markRequiredFields(){
  const r = computeOperatorRequirements();
  labelReq('eu-importer-country',r.needsEUImporter);
  labelReq('eu-ar-country',r.needsEUAR);
  labelReq('uk-importer-country',r.needsGBImporter);
  labelReq('ukrp-country',r.needsUKRP);
}
document.getElementById('country-of-origin').addEventListener('change',markRequiredFields);
document.getElementById('legal-manufacturer-country').addEventListener('change',markRequiredFields);

/* ------------ Product -> Attributes visibility ------------ */
function updateAttributesVisibility(){
  const product = document.getElementById('product').value;
  document.querySelectorAll('.attribute-item').forEach(item=>{
    const list = (item.getAttribute('data-products')||'').split(',');
    const cb = item.querySelector('input');
    if(product==='none' || list.includes(product)){
      item.style.display='flex'; cb.disabled=false;
    }else{ item.style.display='none'; cb.checked=false; cb.disabled=true; }
  });
}

/* ------------ Machinery variants UI ------------- */
function showMachineryBlock(show){
  document.getElementById('machinery-variant-block').style.display = show ? 'block':'none';
  if(!show){
    document.getElementById('mach-variant').value='none';
    const box = document.getElementById('variant-details');
    box.style.display='none'; box.innerHTML='';
  }
}
function clearVariantUI() {
  const sel = document.getElementById('mach-variant');
  if (sel) sel.innerHTML = '<option value="none">Select a Machinery variant</option>';
  document.getElementById('variant-details')?.replaceChildren();
}

function populateMachineryVariants(){
  const sel = document.getElementById('mach-variant');
  sel.innerHTML = '<option value="none">Select a Machinery variant</option>';
  getMachineryVariants().forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.id;
    opt.textContent = v.label || v.id;
    sel.appendChild(opt);
  });
}

// Render variant detail pills for BOTH schemas
function renderVariantDetails(variant) {
  const box = document.getElementById('variant-details');
  box.innerHTML = '';
  box.style.display = 'none';
  if (!variant) return;

  // --- Base standards info ---
  const base = variant.base_standards || variant.baseStandards || [];
  if (base.length) {
    const info = document.createElement('div');
    info.className = 'muted';
    info.textContent = 'Variant base standards: ' + base.join(', ');
    box.appendChild(info);
  }

  // --- Drive type options ---
  if (variant.details?.driveTypes?.length) {
    const title = document.createElement('div');
    title.className = 'group-title';
    title.textContent = 'Press drive type';
    box.appendChild(title);

    const wrap = document.createElement('div');
    box.appendChild(wrap);

    variant.details.driveTypes.forEach(d => {
      const pill = document.createElement('label');
      pill.className = 'pill';
      pill.innerHTML = `<input type="checkbox" id="${d.id}" value="${d.id}"> ${d.label}`;
      wrap.appendChild(pill);
    });

    // ‚úÖ Drive-type listener ‚Äî handles hydraulic/pneumatic highlights
    wrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        const selectedDrive = variant.details.driveTypes.find(d => d.id === cb.value);
        if (selectedDrive) {
          variant.details.selectedDrive = selectedDrive;
          console.log("Selected drive:", selectedDrive);
          applyVariantAttributeHints(variant);
        }
      });
    });
  }

  // --- Schema B (secondary detail sets, e.g. packaging/robot) ---
  if (variant.details && typeof variant.details === 'object') {
    const d = variant.details;
    const map = {
      accessories: 'Lifting accessory type',
      types: 'Packaging machine type (EN 415 series)',
      families: 'Woodworking family',
      dust: 'Dust / explosion risk'
    };
    for (const [key, arr] of Object.entries(d)) {
      if (!Array.isArray(arr) || !arr.length || key === 'driveTypes') continue;
      const title = document.createElement('div');
      title.className = 'group-title';
      title.textContent = map[key] || key;
      box.appendChild(title);

      const wrap = document.createElement('div');
      box.appendChild(wrap);

      arr.forEach(c => {
        const pill = document.createElement('label');
        pill.className = 'pill';
        pill.innerHTML = `<input type="checkbox" id="${variant.id}-${key}-${c.id}" data-std="${c.standard||''}"> ${c.label}`;
        wrap.appendChild(pill);
      });
    }

    // Special case: robots
    if (variant.id === 'robot' && d.collaborative) {
      const title = document.createElement('div');
      title.className = 'group-title';
      title.textContent = 'Robot mode / application';
      box.appendChild(title);

      const wrap = document.createElement('div');
      box.appendChild(wrap);

      const pill = document.createElement('label');
      pill.className = 'pill';
      pill.innerHTML = `<input type="checkbox" id="robot-cobot" data-std="ISO/TS 15066"> Collaborative operation (ISO/TS 15066)`;
      wrap.appendChild(pill);
    }
  }

  box.style.display = 'block';
}
    
// Highlight (and optionally auto-check) the variant's suggested attributes
function applyVariantAttributeHints(variant, { autoCheck = false } = {}) {
  // üîπ Clear all existing highlights first
  document.querySelectorAll('.attribute-item label')
    .forEach(l => l.classList.remove('auto-suggest'));

  if (!variant) return;

  // üîπ Collect top-level suggested attributes (e.g., functional-safety)
  let hints = Array.isArray(variant.suggestAttributes)
    ? [...variant.suggestAttributes]
    : [];

  // üîπ Add suggestions from all checked drive types
  document.querySelectorAll('#variant-details input[type="checkbox"]:checked')
    .forEach(cb => {
      const drive = variant.details?.driveTypes?.find(d => d.id === cb.value);
      if (drive?.suggestAttributes?.length) {
        hints.push(...drive.suggestAttributes);
      }
    });

  // üîπ Apply the highlights (green outlines)
  hints.forEach(attrId => {
    const cb = document.getElementById(attrId);
    if (!cb) return;
    const lbl = cb.parentElement.querySelector('label') || cb.nextElementSibling;
    if (lbl) lbl.classList.add('auto-suggest');
    if (autoCheck) cb.checked = true;
  });
}
 
/* ------------ Rules engine: frameworks ------------- */
const ukMarkingPolicy = { general:{ceRecognition:'indefinite'} };

function baseFrameworks(product, attrs, destinations){
  const needWireless = attrs.includes('wireless-connectivity') || attrs.includes('wireless-hmi');
  const res = [];
  const add = (t,m=[])=>res.push({text:t,specificMarkets:m});
  const hasEMC     = attrs.includes('emc-electrical-equip') || attrs.includes('wireless-hmi') || attrs.includes('wireless-connectivity');
  const hasATEX    = attrs.includes('hazardous-location') || attrs.includes('hazardous-environment-design');
  const hasPED     = attrs.includes('ped-pressure-parts');
  const hasOutdoor = attrs.includes('outdoor-use');

  if(destinations.some(d=>MARKET_GROUP[d]==='eu')){
    const EU=['eu'];
    const addLVD_EMC=()=>{ add('EU Low Voltage Directive (2014/35/EU): electrical safety (CE, EU DoC, technical file).',EU); add('EU Electromagnetic Compatibility (2014/30/EU): electromagnetic compatibility (CE).',EU); };
    switch(product){
    case 'machinery':
case 'machinery':
  add('EU Machinery Directive 2006/42/EC / transition to Machinery Regulation (EU) 2023/1230: CE; NB involvement per category.', EU);
  add('Apply EN ISO 12100 risk assessment and EN 60204-1 for electrical equipment of machinery.', EU);

  // Conditional directives based on selected attributes
  if (attrs.includes('emc-electrical-disturbance'))
    add('EU Electromagnetic Compatibility (2014/30/EU): applies when machinery includes electrical/electronic equipment.', EU);
  if (attrs.includes('pressure-equipment'))
    add('EU Pressure Equipment Directive (2014/68/EU): applies where the machinery contains pressurised parts above the Pressure Equipment Directive thresholds.', EU);
  if (attrs.includes('hazardous-location'))
    add('EU Explosive Atmosphere Directive (2014/34/EU): applies when the machinery is intended for use in a potentially explosive atmosphere.', EU);
  if (attrs.includes('outdoor-use'))
    add('EU Outdoor Noise Directive (2000/14/EC): applies when the machinery is intended for outdoor use.', EU);
  break;

      case 'low-voltage-switchgear':
      case 'electrical-equipment-measurement':
      case 'heat-pumps-airconditioners':
      case 'commercial-refrigerating':
      case 'air-cleaning-appliances':
      case 'luminaires':
        addLVD_EMC();break;
      case 'audio-video-equipment':
      case 'video-surveillance':
        addLVD_EMC(); if(needWireless) add('EU Radio Equipment Directive (2014/53/EU): radio spectrum + safety + Electromagnetic Compatibility under Radio Equipment Directive (CE).',EU); break;
      case 'explosive-atmospheres-equipment':
        add('EU Explosive Atmosphere Product Directive (2014/34/EU): CE; NB involvement by category/zone.',EU); break;
      case 'medical-electrical-equipment':
        add('EU MDR (2017/745): CE; EN 60601-1 safety; EN 60601-1-2 Electromagnetic Compatibility; EN 62366 usability; EN ISO 14971 risk. Low Voltage Directive not applied.',EU); break;
      case 'low-voltage-cables':
        add('EU CPR (305/2011) for reaction-to-fire (EN 50575): CE with Declaration of Performance (DoP).',EU); break;
      case 'photovoltaic-systems':
      case 'power-installations':
        add('EU: installation/system standards apply; CE marking is for constituent equipment (e.g., inverters under Low Voltage Directive/Electromagnetic Compatibility).',EU); break;
      default:
        addLVD_EMC();
    }
    if(['audio-video-equipment','video-surveillance','luminaires','heat-pumps-airconditioners','commercial-refrigerating','air-cleaning-appliances','electrical-equipment-measurement','low-voltage-switchgear'].includes(product)){
      add('EU RoHS (2011/65/EU) where in EEE scope.',EU);
      add('EU WEEE (2012/19/EU) producer obligations where in scope.',EU);
      if (hasEMC)    add('EU Electromagnetic Compatibility (2014/30/EU): electromagnetic compatibility (CE).', EU);
  if (hasPED)    add('EU Pressure Equipment (2014/68/EU): classify, select module; CE where in scope.', EU);
  if (hasATEX)   add('EU Explosive Atmosphere Product (2014/34/EU): equipment for potentially explosive atmospheres; CE; NB by category/zone.', EU);
  if (hasOutdoor) add('EU Outdoor Noise (2000/14/EC): noise emission of outdoor equipment; CE where in scope.', EU);
    }
  }
  if(destinations.includes('uk')){
    add('GB Electrical Equipment (Safety) Regulations 2016 (UK Low Voltage Directive analogue).',['uk']);
    add('GB Electromagnetic Compatibility Regulations 2016.',['uk']);
    if(needWireless) add('GB Radio Equipment Regulations 2017.',['uk']);
    if(product==='explosive-atmospheres-equipment') add('UKEX: Equipment for Use in Potentially Explosive Atmospheres Regulations 2016.',['uk']);
    if(product==='medical-electrical-equipment') add('UK Medical Devices Regulations 2002 (as amended).',['uk']);
    if(['audio-video-equipment','video-surveillance','luminaires','heat-pumps-airconditioners','commercial-refrigerating','air-cleaning-appliances','electrical-equipment-measurement','low-voltage-switchgear'].includes(product)){
      add('GB RoHS analogue; GB WEEE producer obligations (scope-dependent).',['uk']);
    }
    add(`GB: CE marking recognised ${ukMarkingPolicy.general.ceRecognition} for most sectors; UKCA also valid. Choose CE, UKCA or dual strategy.`,['uk']);
  }
  if(destinations.includes('usa')){
    if(needWireless) add('FCC 47 CFR Part 15 (intentional radiators): certification/SDoC as applicable.',['usa']);
    else add('FCC 47 CFR Part 15B (unintentional radiators): SDoC for digital devices where applicable.',['usa']);
    if(['machinery','low-voltage-switchgear','electrical-equipment-measurement','luminaires','heat-pumps-airconditioners','commercial-refrigerating','air-cleaning-appliances','audio-video-equipment','video-surveillance'].includes(product)){
      add('OSHA: NRTL listing typically expected for workplace installation (UL/CSA/ETL to relevant standards).',['usa']);
    }
  }
  return res;
}

// Collect standards from whichever schema is in use
function variantStandards(product){
  if(product !== 'machinery') return [];
  const out = [];
  const add = (t) => out.push({ text: t, specificMarkets: ['eu'] });

  const vId = document.getElementById('mach-variant').value;
  if (vId === 'none') return out;

  const v = getCatalogVariant(vId);
  if (!v) return out;

  (v.base_standards || v.baseStandards || []).forEach(s => add(s));

  // From pills: handle both data-adds and data-std
  document.querySelectorAll('#variant-details input[type="checkbox"]:checked').forEach(ch => {
    const adds = ch.getAttribute('data-adds');
    const std = ch.getAttribute('data-std');
    if (adds) adds.split('::').filter(Boolean).forEach(s => add(s));
    if (std) add(std);
  });

  return out;
}

/* ------------ Economic operator & certifications (kept) ------------- */
function econOperatorDuties(origin, destinations, product, attrs){
  const res=[]; const add=(t,m=[])=>res.push({text:t,specificMarkets:m});
  const legalManu = document.getElementById('legal-manufacturer-country').value || 'none';
  const manu = (legalManu!=='none') ? legalManu : origin;
  const goingEU = destinations.some(d=>EU_SET.has(d));
  const goingUK = destinations.includes('uk');
  const goingUS = destinations.includes('usa');

  if(goingEU && !EU_SET.has(manu)){
    add(`EU importer required: name & EU address on product/packaging; ensure CE compliance; hold EU DoC & technical file.`,['eu']);
  }
  if(goingUK && manu!=='uk'){
    add(`GB importer required: name & GB address; keep UK DoC available; apply chosen GB marking plan.`,['uk']);
  }
  if(goingUS){
    add('US: coordinate Importer of Record (customs) and ensure FCC/NRTL obligations are met prior to import.',['usa']);
  }
  return res;
}

function certificationRequirements(certs, product, attrs, destinations){
  const res=[]; const add=(t,m=[])=>res.push({text:t,specificMarkets:m});
  if(certs.includes('ce-marking') && destinations.some(d=>MARKET_GROUP[d]==='eu')){
    add('EU: Prepare EU Declaration of Conformity referencing applicable directives/regulations and harmonised standards.',['eu']);
    add('EU: Compile technical documentation (risk assessment, test reports, drawings, instructions, labeling, conformity assessment route).',['eu']);
  }
  if(certs.includes('ukca-ce-gb') && destinations.includes('uk')){
    add('GB: Implement chosen marking plan (CE only / UKCA only / dual). Keep UK Declaration of Conformity and technical documentation.',['uk']);
    const plan = document.getElementById('gb-plan').value || 'ce';
    add(`GB plan selected: ${plan.toUpperCase()}.`,['uk']);
  }
  if(certs.includes('ul-listing') && destinations.includes('usa')){
    add('US: Obtain NRTL listing (UL/CSA/ETL) to the applicable UL/ANSI or CSA standard for workplace acceptance.',['usa']);
  }
  if(certs.includes('ce-notified-body')){
    const mkts=[]; if(destinations.some(d=>MARKET_GROUP[d]==='eu')) mkts.push('eu'); if(destinations.includes('uk')) mkts.push('uk');
    if(mkts.length) add('Third-party assessment: engage Notified Body / UK Approved Body where required (e.g., MDR, Explosive Atmosphere, certain modules).',mkts);
  }
  return res;
}

  function clearCertificationHints(){
  document.querySelectorAll('.certification-item label').forEach(l => l.classList.remove('auto-suggest'));
}

function applyCertificationHints(requirements, destinations, product) {
  clearCertificationHints();
  const hasEU = destinations.some(d => MARKET_GROUP[d] === 'eu');
  const hasUK = destinations.includes('uk');

  // CE-based directives or regulations that require CE marking
  const ceWords = [
    'Machinery Directive',
    '2014/30/EU',  // EMC
    '2014/34/EU',  // ATEX
    '2014/68/EU',  // Pressure Equipment
    '2000/14/EC'   // Outdoor Noise
  ];

  const ceInReqs = (requirements || []).some(r =>
    ceWords.some(w => (r.text || '').includes(w))
  );

  const ceBox = document.getElementById('ce-marking');
  const ukBox = document.getElementById('ukca-ce-gb');

  // --- CE MARKING (EU) ---
  if (ceBox) {
    const lbl = ceBox.nextElementSibling;
    if (hasEU && (product === 'machinery' || ceInReqs)) {
      lbl.classList.add('auto-suggest');
      ceBox.checked = true;
    } else {
      lbl.classList.remove('auto-suggest');
      ceBox.checked = false;
    }
  }

  // --- UKCA / CE (Great Britain) ---
  if (ukBox) {
    const lbl = ukBox.nextElementSibling;
    if (hasUK) {
      lbl.classList.add('auto-suggest');
      ukBox.checked = true;
    } else {
      lbl.classList.remove('auto-suggest');
      ukBox.checked = false;
    }
  }
}
  
// ---------- Variant change handler ----------
function onMachVariantChange() {
  const sel = document.getElementById('mach-variant');
  const v = getCatalogVariant(sel?.value);

  // Render variant details (drive-type pills)
  renderVariantDetails(v);

  // Attach listeners for drive-type toggles (update hints live)
  const driveBoxes = document.querySelectorAll('#variant-details input[type="checkbox"]');
  driveBoxes.forEach(cb => {
    cb.addEventListener('change', () => applyVariantAttributeHints(v));
  });

  // Initial highlights (e.g. functional safety)
  applyVariantAttributeHints(v);
}
  
/* ------------ Wiring: product & variant changes ------------- */
document.getElementById('product').addEventListener('change', () => {
  const product = document.getElementById('product').value;

  // 1) Clear prior highlights
  clearAutoSuggest();
  clearCertificationHints();

  // 2) Reset machinery-specific UI
  const variantSel = document.getElementById('mach-variant');
  const detailsBox = document.getElementById('variant-details');
  if (variantSel) variantSel.innerHTML = '<option value="none">Select a Machinery variant</option>';
  if (detailsBox) { detailsBox.innerHTML = ''; detailsBox.style.display = 'none'; }

  // 3) Normal product-driven updates
  updateAttributesVisibility();
  if (product === 'machinery') {
    showMachineryBlock(true);
    populateMachineryVariants();

    // If a variant is already selected (or defaulted), render its pills now
    if (variantSel && variantSel.value !== 'none') onMachVariantChange();
  } else {
    showMachineryBlock(false);
  }

  // 4) Advanced section + CE/UKCA halos
  toggleAdvancedSection();
  applyCertificationHints(
    window.currentRequirementsAll || [],
    getSelectedDestinations(),
    product
  );
});

  // Destinations changed ‚Üí update advanced section + CE/UKCA halos
document.querySelectorAll('.market-item input').forEach(cb =>
  cb.addEventListener('change', () => {
    toggleAdvancedSection();
    applyCertificationHints(
      window.currentRequirementsAll || [],  // may be empty until first Generate
      getSelectedDestinations(),
      document.getElementById('product').value
    );
  })
);

function generateRoadmap() {
  const productSel = document.getElementById('product');
  const product = productSel.value;
  const originSel = document.getElementById('country-of-origin');
  const destinations = getSelectedDestinations();
  const attrs = getSelectedAttributes();
  const certs = getSelectedCertifications();

  if (product === 'none') return alert('Please select a product or system.');
  if (originSel.value === 'none') return alert('Please select the place of manufacture (origin).');
  if (destinations.length === 0) return alert('Please select at least one destination market.');

  const r = computeOperatorRequirements();
  if (r.needsEUImporter && document.getElementById('eu-importer-country').value === 'none') return alert('Please select an EU importer country.');
  if (r.needsEUAR && document.getElementById('eu-ar-country').value === 'none') return alert('Please select an EU Authorized Representative country.');
  if (r.needsGBImporter && document.getElementById('uk-importer-country').value === 'none') return alert('Please select the GB importer country.');
  if (r.needsUKRP && document.getElementById('ukrp-country').value === 'none') return alert('Please select the UK Responsible Person country.');

  let requirements = [];

  // --- Standards first ---
  requirements = requirements.concat(variantStandards(product)); // Variant type-C standards
  requirements = requirements.concat(baseFrameworks(product, attrs, destinations)); // Base EN standards & directives

  // --- Country-specific or additional rules ---
  if (destinations.includes('italy') && ['power-installations', 'lightning-protection', 'photovoltaic-systems'].includes(product)) {
    requirements.push({
      text: 'Italy (installation): D.M. 37/2008 + CEI installation codes (e.g., CEI 64-8; CEI 0-21/0-16; CEI 11-27).',
      specificMarkets: ['italy']
    });
  }

  // --- Operator & certification duties last ---
  requirements = requirements.concat(econOperatorDuties(originSel.value, destinations, product, attrs));
  requirements = requirements.concat(certificationRequirements(certs, product, attrs, destinations));

  // --- Reuse + update CE/UKCA hints ---
  window.currentRequirementsAll = requirements;
  applyCertificationHints(requirements, destinations, product);

  // --- Render visible list ---
  const list = document.getElementById('roadmap-list');
  list.innerHTML = '';
  const shown = [];
  requirements.forEach(req => {
    const showAll = !req.specificMarkets?.length;
    const showEU = req.specificMarkets?.includes('eu') && destinations.some(d => ['france', 'germany', 'italy'].includes(d));
    const showOne = req.specificMarkets?.some(m => destinations.includes(m));
    if (showAll || showEU || showOne) {
      shown.push(req);
      const li = document.createElement('li');
      li.textContent = req.text;
      list.appendChild(li);
    }
  });

  // --- Store details + show section ---
  window.currentRoadmapDetails = {
    product: productSel.options[productSel.selectedIndex].text,
    attributes: attrs,
    certifications: certs,
    countryOfOrigin: originSel.options[originSel.selectedIndex].text,
    destinations: destinations,
    requirementsAll: requirements,
    requirementsShown: shown
  };

  document.getElementById('roadmap-section').style.display = 'block';
}

function exportToCitation(){
  alert('Exporting to ACS: a Base record plus Detailed requirements with tasks/evidence scaffolding will be created from the roadmap.');
}

function exportToCSV(){
  const d = window.currentRoadmapDetails;
  if(!d) return alert('No requirements to export. Please generate the roadmap first.');
  const labels = {france:'France',germany:'Germany',italy:'Italy',uk:'United Kingdom',usa:'United States'};
  let csv='';
  csv += 'Product,"'+d.product.replace(/"/g,'""')+'"\n';
  csv += 'Attributes,"'+(d.attributes.join(', ')||'None').replace(/"/g,'""')+'"\n';
  csv += 'Certifications,"'+(d.certifications.join(', ')||'None').replace(/"/g,'""')+'"\n';
  csv += 'Origin,"'+d.countryOfOrigin.replace(/"/g,'""')+'"\n';
  csv += 'Destinations,"'+d.destinations.map(x=>labels[x]||x).join('; ').replace(/"/g,'""')+'"\n\n';
  csv += 'Requirement,Specific Markets\n';
  (d.requirementsShown||[]).forEach(r=>{
    const mkts = (r.specificMarkets?.length) ? r.specificMarkets.join('; ') : 'All Markets';
    csv += `"${r.text.replace(/"/g,'""')}","${mkts.replace(/"/g,'""')}"\n`;
  });
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='compliance_requirements.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
    document.getElementById('mach-variant')
  .addEventListener('change', onMachVariantChange);
  
/* ------------ Init ------------ */
(async function init() {
  try {
    await loadCatalog();
    console.log("‚úÖ catalog.json loaded:", CATALOG);
  } catch (e) {
    console.error("‚ö†Ô∏è Could not load catalog.json ‚Äî see console for details.", e);
    alert('Could not load catalog.json ‚Äî see console for details.');
    return;
  }

  // --- 1. Initial UI setup ---
  updateAttributesVisibility();
  showMachineryBlock(false);
  toggleAdvancedSection();

  // --- 2. If Machinery is already preselected, show its variants ---
  const productSel = document.getElementById('product');
  if (productSel?.value === 'machinery') {
    showMachineryBlock(true);
    populateMachineryVariants();
  }

  // --- 3. Run certification halo logic once after everything is ready ---
  applyCertificationHints(
    window.currentRequirementsAll || [],
    getSelectedDestinations(),
    document.getElementById('product').value
  );

  console.log("‚úÖ Init complete ‚Äî UI ready");
})();
</script>
</body>
</html>




